<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="clr-namespace:FrapaClonia.UI.ViewModels;assembly=FrapaClonia.UI"
             xmlns:mi="clr-namespace:Material.Icons.Avalonia;assembly=Material.Icons.Avalonia"
             xmlns:converters="clr-namespace:FrapaClonia.UI.Converters;assembly=FrapaClonia.UI"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             mc:Ignorable="d" d:DesignWidth="700" d:DesignHeight="700"
             x:Class="FrapaClonia.UI.Views.DeploymentView"
             x:DataType="vm:DeploymentViewModel">

  <Design.DataContext>
    <vm:DeploymentViewModel />
  </Design.DataContext>

  <UserControl.Resources>
    <converters:BoolToAvailableStringConverter x:Key="BoolToAvailableStringConverter" />
    <converters:BoolToDeployedStringConverter x:Key="BoolToDeployedStringConverter" />
    <converters:BoolNegationConverter x:Key="BoolNegationConverter" />
    <converters:StringEqualsConverter x:Key="StringEqualsConverter" />
  </UserControl.Resources>

  <UserControl.Styles>
    <StyleInclude Source="avares://FrapaClonia.UI/Styles/SharedStyles.axaml" />
  </UserControl.Styles>

  <ScrollViewer HorizontalScrollBarVisibility="Disabled">
    <Panel Margin="{StaticResource ContentPadding}">
      <StackPanel Spacing="{StaticResource SpacingL}">
        <!-- Header -->
        <TextBlock Text="{DynamicResource Localized_Deployment}"
                   Classes="page-title" />

        <!-- Deployment Mode Selection -->
        <Border Classes="settings-card">
          <StackPanel Spacing="{StaticResource SpacingM}">
            <StackPanel Orientation="Horizontal" Spacing="4" VerticalAlignment="Center">
              <TextBlock Text="{DynamicResource Localized_DeploymentMode}"
                         Classes="section-title"
                         VerticalAlignment="Center" />
              <Button Classes="hint-icon" VerticalAlignment="Center">
                <ToolTip.Tip>
                  <TextBlock Text="{DynamicResource Localized_ChooseHowYouWantToDeployAndRunFrpc}" />
                </ToolTip.Tip>
              </Button>
            </StackPanel>

            <StackPanel Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
              <RadioButton Content="Native"
                           IsChecked="{Binding SelectedDeploymentMode, Converter={StaticResource StringEqualsConverter}, ConverterParameter=native, Mode=TwoWay}"
                           GroupName="DeploymentMode" />
              <RadioButton Content="Docker"
                           IsChecked="{Binding SelectedDeploymentMode, Converter={StaticResource StringEqualsConverter}, ConverterParameter=docker, Mode=TwoWay}"
                           GroupName="DeploymentMode" />
            </StackPanel>
          </StackPanel>
        </Border>

        <!-- Native Deployment Panel -->
        <Border Classes="settings-card" IsVisible="{Binding IsNativeMode}">
          <StackPanel Spacing="{StaticResource SpacingL}">
            <TextBlock Text="{DynamicResource Localized_ServiceConfiguration}"
                       Classes="section-title" />

            <!-- Frpc Executable Configuration -->
            <StackPanel Spacing="{StaticResource SpacingM}">
              <TextBlock Text="{DynamicResource Localized_FrpcExecutableLocation}"
                         Classes="field-label" />

              <!-- Path Input with Check and Configure Buttons -->
              <Grid ColumnDefinitions="*,Auto,Auto">
                <TextBox Grid.Column="0"
                         Text="{Binding FrpcBinaryPath}"
                         Watermark="{DynamicResource Localized_SelectFrpcBinary}"
                         IsReadOnly="True"
                         Margin="0,0,8,0" />
                <Button Grid.Column="1"
                        Command="{Binding CheckFrpcPathCommand}"
                        IsEnabled="{Binding !IsCheckingPath}"
                        Classes="action-button"
                        Margin="0,0,8,0"
                        ToolTip.Tip="{DynamicResource Localized_CheckFrpcPathToolTip}">
                  <StackPanel Orientation="Horizontal" Spacing="4">
                    <mi:MaterialIcon Kind="Check" />
                    <TextBlock Text="{DynamicResource Localized_Check}" />
                  </StackPanel>
                </Button>
                <Button Grid.Column="2"
                        Command="{Binding ConfigureFrpcCommand}"
                        Classes="action-button primary"
                        ToolTip.Tip="{DynamicResource Localized_ConfigureFrpcToolTip}">
                  <StackPanel Orientation="Horizontal" Spacing="4">
                    <mi:MaterialIcon Kind="Cog" />
                    <TextBlock Text="{DynamicResource Localized_Configure}" />
                  </StackPanel>
                </Button>
              </Grid>

              <!-- Validation Status -->
              <Grid ColumnDefinitions="*,Auto">
                <!-- Checking indicator -->
                <StackPanel Grid.Column="0"
                            Orientation="Horizontal" Spacing="8"
                            IsVisible="{Binding IsCheckingPath}">
                  <mi:MaterialIcon Kind="Loading" Width="20" Height="20" />
                  <TextBlock Text="{DynamicResource Localized_CheckingFrpc}"
                             VerticalAlignment="Center" />
                </StackPanel>

                <!-- Valid path status -->
                <StackPanel Grid.Column="0"
                            Orientation="Horizontal" Spacing="8"
                            IsVisible="{Binding !IsCheckingPath}">
                  <mi:MaterialIcon Kind="CheckCircle"
                                   Foreground="Green"
                                   IsVisible="{Binding IsPathValid}"
                                   Width="20" Height="20" />
                  <mi:MaterialIcon Kind="AlertCircle"
                                   Foreground="Orange"
                                   IsVisible="{Binding !IsPathValid}"
                                   Width="20" Height="20" />
                  <TextBlock Text="{Binding DetectedVersion, StringFormat='v{0}'}"
                             IsVisible="{Binding IsPathValid}"
                             Foreground="Green"
                             VerticalAlignment="Center" />
                  <TextBlock Text="{DynamicResource Localized_FrpcNotConfigured}"
                             IsVisible="{Binding !IsPathValid}"
                             Foreground="Orange"
                             VerticalAlignment="Center" />
                </StackPanel>
              </Grid>
            </StackPanel>

            <!-- Service Configuration Section -->
            <Border Classes="settings-card" Background="{DynamicResource SystemControlBackgroundAltHighBrush}">
              <StackPanel Spacing="{StaticResource SpacingM}">
                <TextBlock Text="{DynamicResource Localized_SystemServiceSettings}"
                           Classes="section-title" />

                <CheckBox Content="{DynamicResource Localized_InstallAsSystemService}"
                          IsChecked="{Binding ServiceEnabled}" />

                <StackPanel Spacing="8" IsVisible="{Binding ServiceEnabled}">
                  <TextBlock Text="{DynamicResource Localized_ServiceScope}"
                             Classes="field-label" />
                  <StackPanel Orientation="Horizontal" Spacing="8">
                    <RadioButton Content="{DynamicResource Localized_UserLevel}"
                                 IsChecked="{Binding ServiceScopeValue, Converter={StaticResource StringEqualsConverter}, ConverterParameter=user}"
                                 GroupName="ServiceScope" />
                    <RadioButton Content="{DynamicResource Localized_SystemLevel}"
                                 IsChecked="{Binding ServiceScopeValue, Converter={StaticResource StringEqualsConverter}, ConverterParameter=system}"
                                 GroupName="ServiceScope" />
                  </StackPanel>

                  <CheckBox Content="{DynamicResource Localized_StartOnBoot}"
                            IsChecked="{Binding AutoStartOnBoot}" />

                  <!-- Service Status -->
                  <Grid ColumnDefinitions="180,*" RowDefinitions="Auto"
                        Margin="0,8,0,0">
                    <TextBlock Grid.Row="0" Grid.Column="0"
                               Text="{DynamicResource Localized_ServiceStatus}"
                               Classes="field-label" />
                    <StackPanel Grid.Row="0" Grid.Column="1"
                                Orientation="Horizontal"
                                Spacing="{StaticResource SpacingM}">
                      <TextBlock Text="{Binding ServiceStatus.State}"
                                 VerticalAlignment="Center"
                                 FontFamily="{DynamicResource MonoFontFamily}" />
                      <Button Command="{Binding RefreshServiceStatusCommand}"
                              IsEnabled="{Binding !IsServiceChecking}"
                              Classes="action-button">
                        <mi:MaterialIcon Kind="Refresh" />
                      </Button>
                    </StackPanel>
                  </Grid>

                  <!-- Service Control Buttons -->
                  <StackPanel Orientation="Horizontal"
                              Spacing="{StaticResource SpacingM}"
                              Margin="0,8,0,0">
                    <Button Command="{Binding InstallServiceCommand}"
                            IsVisible="{Binding !IsServiceInstalled}"
                            IsEnabled="{Binding IsPathValid}"
                            Classes="action-button primary icon-text-button">
                      <StackPanel Orientation="Horizontal" Spacing="4">
                        <mi:MaterialIcon Kind="Cog" />
                        <TextBlock Text="{DynamicResource Localized_InstallService}" />
                      </StackPanel>
                    </Button>
                    <Button Command="{Binding UninstallServiceCommand}"
                            IsVisible="{Binding IsServiceInstalled}"
                            Classes="action-button destructive icon-text-button">
                      <StackPanel Orientation="Horizontal" Spacing="4">
                        <mi:MaterialIcon Kind="Delete" />
                        <TextBlock Text="{DynamicResource Localized_UninstallService}" />
                      </StackPanel>
                    </Button>
                    <Button Command="{Binding StartServiceCommand}"
                            IsVisible="{Binding IsServiceInstalled}"
                            IsEnabled="{Binding !IsServiceRunning}"
                            Classes="action-button icon-text-button">
                      <StackPanel Orientation="Horizontal" Spacing="4">
                        <mi:MaterialIcon Kind="Play" />
                        <TextBlock Text="{DynamicResource Localized_Start}" />
                      </StackPanel>
                    </Button>
                    <Button Command="{Binding StopServiceCommand}"
                            IsVisible="{Binding IsServiceInstalled}"
                            IsEnabled="{Binding IsServiceRunning}"
                            Classes="action-button icon-text-button">
                      <StackPanel Orientation="Horizontal" Spacing="4">
                        <mi:MaterialIcon Kind="Stop" />
                        <TextBlock Text="{DynamicResource Localized_Stop}" />
                      </StackPanel>
                    </Button>
                  </StackPanel>
                </StackPanel>
              </StackPanel>
            </Border>
          </StackPanel>
        </Border>

        <!-- Docker Deployment Panel -->
        <Border Classes="settings-card" IsVisible="{Binding IsDockerMode}">
          <StackPanel Spacing="{StaticResource SpacingM}">
            <TextBlock Text="{DynamicResource Localized_DockerDeployment}"
                       Classes="section-title" />

            <Grid ColumnDefinitions="180,*" RowDefinitions="Auto,Auto"
                  RowSpacing="{StaticResource SpacingS}">
              <TextBlock Grid.Row="0" Grid.Column="0"
                         Text="{DynamicResource Localized_DockerStatus}"
                         Classes="field-label" />
              <StackPanel Grid.Row="0" Grid.Column="1"
                          Orientation="Horizontal"
                          Spacing="{StaticResource SpacingM}">
                <TextBlock Text="{Binding IsDockerAvailable, Converter={StaticResource BoolToAvailableStringConverter}}"
                           VerticalAlignment="Center" />
                <Button Command="{Binding CheckDockerCommand}"
                        Content="{DynamicResource Localized_CheckDocker}"
                        IsEnabled="{Binding !IsDockerChecking}"
                        Classes="action-button" />
              </StackPanel>

              <TextBlock Grid.Row="1" Grid.Column="0"
                         Text="{DynamicResource Localized_ContainerName}"
                         Classes="field-label" />
              <TextBox Grid.Row="1" Grid.Column="1"
                       Text="{Binding DockerContainerName}"
                       Watermark="frapa-clonia-frpc"
                       MinWidth="200" />
            </Grid>

            <TextBlock Text="{DynamicResource Localized_DockerImage}"
                       Classes="field-label"
                       Margin="{StaticResource ThicknessTopS}" />
            <TextBox Text="{Binding DockerImageName}"
                     Watermark="fatedier/frpc:latest" />

            <TextBlock Text="{DynamicResource Localized_DockerComposePath}"
                       Classes="field-label"
                       Margin="{StaticResource ThicknessTopS}" />
            <TextBox Text="{Binding DockerComposePath}"
                     IsReadOnly="True"
                     Watermark="Not generated yet" />

            <StackPanel Orientation="Horizontal"
                        Spacing="{StaticResource SpacingM}"
                        Margin="{StaticResource ThicknessTopS}">
              <Button Command="{Binding GenerateDockerComposeCommand}"
                      Classes="action-button icon-text-button">
                <StackPanel Orientation="Horizontal" Spacing="4">
                  <mi:MaterialIcon Kind="FileDocument" />
                  <TextBlock Text="{DynamicResource Localized_GenerateDockerComposeYml}" />
                </StackPanel>
              </Button>
              <Button Command="{Binding StartDockerCommand}"
                      Classes="action-button primary icon-text-button">
                <StackPanel Orientation="Horizontal" Spacing="4">
                  <mi:MaterialIcon Kind="Play" />
                  <TextBlock Text="{DynamicResource Localized_StartContainer}" />
                </StackPanel>
              </Button>
              <Button Command="{Binding StopDockerCommand}"
                      Classes="action-button destructive icon-text-button">
                <StackPanel Orientation="Horizontal" Spacing="4">
                  <mi:MaterialIcon Kind="Stop" />
                  <TextBlock Text="{DynamicResource Localized_StopContainer}" />
                </StackPanel>
              </Button>
            </StackPanel>
          </StackPanel>
        </Border>

        <!-- Information -->
        <Border Classes="settings-card">
          <StackPanel Spacing="{StaticResource SpacingS}">
            <StackPanel Orientation="Horizontal" Spacing="4">
              <TextBlock Text="{DynamicResource Localized_DeploymentInformation}"
                         Classes="section-title" />
              <Button Classes="icon-button">
                <ToolTip.Tip>
                  <StackPanel>
                    <TextBlock Text="{DynamicResource Localized_DockerDeploymentRequiresDocker}" />
                    <TextBlock Text="{DynamicResource Localized_NativeDeploymentDownloadsAndExtracts}" />
                    <TextBlock Text="{DynamicResource Localized_BothMethodsUse}" />
                  </StackPanel>
                </ToolTip.Tip>
              </Button>
            </StackPanel>
          </StackPanel>
        </Border>
      </StackPanel>
    </Panel>
  </ScrollViewer>
</UserControl>
