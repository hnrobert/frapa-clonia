<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="clr-namespace:FrapaClonia.UI.ViewModels;assembly=FrapaClonia.UI"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="700"
             x:Class="FrapaClonia.UI.Views.ServerConfigView"
             x:DataType="vm:ServerConfigViewModel">

    <Design.DataContext>
        <vm:ServerConfigViewModel />
    </Design.DataContext>

    <UserControl.Styles>
        <Style Selector="Button.action-button">
            <Setter Property="Margin" Value="{StaticResource ThicknessRightS}" />
        </Style>

        <!-- Ensure all input controls are vertically centered -->
        <Style Selector="TextBox">
            <Setter Property="VerticalAlignment" Value="Center" />
        </Style>
        <Style Selector="ComboBox">
            <Setter Property="VerticalAlignment" Value="Center" />
        </Style>
        <Style Selector="NumericUpDown">
            <Setter Property="VerticalAlignment" Value="Center" />
        </Style>
    </UserControl.Styles>

    <ScrollViewer HorizontalScrollBarVisibility="Disabled">
        <Panel Margin="{StaticResource ContentPadding}">
            <StackPanel Spacing="{StaticResource SpacingL}" MaxWidth="800">

                <!-- Header -->
                <TextBlock Text="Server Configuration"
                           Classes="page-title" />

                <!-- Server Connection Section -->
                <Border Classes="settings-card">
                    <StackPanel Spacing="{StaticResource SpacingM}">
                        <TextBlock Text="Connection Settings"
                                   Classes="sectionTitle" />

                        <!-- Server Address -->
                        <Grid ColumnDefinitions="140,*" RowDefinitions="Auto,Auto">
                            <TextBlock Grid.Row="0" Grid.Column="0"
                                       Text="Server Address"
                                       Classes="field-label" />
                            <TextBox Grid.Column="1"
                                     Text="{Binding ServerAddr}"
                                     Watermark="e.g., 127.0.0.1 or your-server.com" />
                            <TextBlock Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2"
                                       Text="The address of the frps server"
                                       Classes="hint" />
                        </Grid>

                        <!-- Server Port -->
                        <Grid ColumnDefinitions="140,120,*" RowDefinitions="Auto,Auto">
                            <TextBlock Grid.Row="0" Grid.Column="0"
                                       Text="Server Port"
                                       Classes="field-label" />
                            <NumericUpDown Grid.Column="1"
                                           Value="{Binding ServerPort}"
                                           Minimum="1"
                                           Maximum="65535"
                                           Increment="1"
                                           FormatString="0" />
                            <TextBlock Grid.Column="2"
                                       Text="Default: 7000"
                                       VerticalAlignment="Center" />
                        </Grid>

                        <!-- User -->
                        <Grid ColumnDefinitions="140,*" RowDefinitions="Auto,Auto">
                            <TextBlock Grid.Row="0" Grid.Column="0"
                                       Text="User"
                                       Classes="field-label" />
                            <TextBox Grid.Column="1"
                                     Text="{Binding User}"
                                     Watermark="Optional user name" />
                            <TextBlock Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2"
                                       Text="Optional user name to avoid proxy name conflicts"
                                       Classes="hint" />
                        </Grid>
                    </StackPanel>
                </Border>

                <!-- Authentication Section -->
                <Border Classes="card">
                    <StackPanel Spacing="{StaticResource SpacingM}">
                        <TextBlock Text="Authentication"
                                   Classes="sectionTitle" />

                        <!-- Auth Method -->
                        <Grid ColumnDefinitions="140,180,*" RowDefinitions="Auto">
                            <TextBlock Grid.Row="0" Grid.Column="0"
                                       Text="Method"
                                       Classes="field-label" />
                            <ComboBox Grid.Column="1"
                                      SelectedIndex="{Binding AuthMethodIndex}">
                                <ComboBoxItem>Token</ComboBoxItem>
                                <ComboBoxItem>OIDC</ComboBoxItem>
                            </ComboBox>
                        </Grid>

                        <!-- Token Auth -->
                        <StackPanel Spacing="{StaticResource SpacingM}" IsVisible="{Binding !IsOidcAuth}">
                            <Grid ColumnDefinitions="140,*" RowDefinitions="Auto">
                                <TextBlock Grid.Row="0" Grid.Column="0"
                                           Text="Token"
                                           Classes="field-label" />
                                <TextBox Grid.Column="1"
                                         Text="{Binding Token}"
                                         PasswordChar="*"
                                         Watermark="Enter your authentication token" />
                            </Grid>
                        </StackPanel>

                        <!-- OIDC Auth -->
                        <StackPanel Spacing="{StaticResource SpacingM}" IsVisible="{Binding IsOidcAuth}">
                            <!-- Client ID -->
                            <Grid ColumnDefinitions="140,*" RowDefinitions="Auto">
                                <TextBlock Grid.Row="0" Grid.Column="0"
                                           Text="Client ID"
                                           Classes="field-label" />
                                <TextBox Grid.Column="1"
                                         Text="{Binding OidcClientId}" />
                            </Grid>

                            <!-- Client Secret -->
                            <Grid ColumnDefinitions="140,*" RowDefinitions="Auto">
                                <TextBlock Grid.Row="0" Grid.Column="0"
                                           Text="Client Secret"
                                           Classes="field-label" />
                                <TextBox Grid.Column="1"
                                         Text="{Binding OidcClientSecret}"
                                         PasswordChar="*" />
                            </Grid>

                            <!-- Token Endpoint -->
                            <Grid ColumnDefinitions="140,*" RowDefinitions="Auto">
                                <TextBlock Grid.Row="0" Grid.Column="0"
                                           Text="Token Endpoint"
                                           Classes="field-label" />
                                <TextBox Grid.Column="1"
                                         Text="{Binding OidcTokenEndpointUrl}"
                                         Watermark="https://" />
                            </Grid>

                            <!-- Audience -->
                            <Grid ColumnDefinitions="140,*" RowDefinitions="Auto">
                                <TextBlock Grid.Row="0" Grid.Column="0"
                                           Text="Audience"
                                           Classes="field-label" />
                                <TextBox Grid.Column="1"
                                         Text="{Binding OidcAudience}"
                                         Watermark="Optional audience" />
                            </Grid>

                            <!-- Scope -->
                            <Grid ColumnDefinitions="140,*" RowDefinitions="Auto">
                                <TextBlock Grid.Row="0" Grid.Column="0"
                                           Text="Scope"
                                           Classes="field-label" />
                                <TextBox Grid.Column="1"
                                         Text="{Binding OidcScope}"
                                         Watermark="e.g., openid profile" />
                            </Grid>
                        </StackPanel>
                    </StackPanel>
                </Border>

                <!-- Transport Section -->
                <Border Classes="card">
                    <StackPanel Spacing="{StaticResource SpacingM}">
                        <TextBlock Text="Transport Settings"
                                   Classes="sectionTitle" />

                        <!-- Protocol -->
                        <Grid ColumnDefinitions="140,180,*" RowDefinitions="Auto">
                            <TextBlock Grid.Row="0" Grid.Column="0"
                                       Text="Protocol"
                                       Classes="field-label" />
                            <ComboBox Grid.Column="1"
                                      SelectedIndex="{Binding TransportProtocolIndex}">
                                <ComboBoxItem>TCP</ComboBoxItem>
                                <ComboBoxItem>KCP</ComboBoxItem>
                                <ComboBoxItem>QUIC</ComboBoxItem>
                                <ComboBoxItem>WebSocket</ComboBoxItem>
                                <ComboBoxItem>Secure WebSocket (WSS)</ComboBoxItem>
                            </ComboBox>
                        </Grid>

                        <!-- Timeout and Mux -->
                        <Grid ColumnDefinitions="140,120,20,Auto" RowDefinitions="Auto,Auto">
                            <!-- Dial Timeout -->
                            <TextBlock Grid.Row="0" Grid.Column="0"
                                       Text="Dial Timeout"
                                       Classes="field-label" />
                            <NumericUpDown Grid.Column="1"
                                           Value="{Binding DialServerTimeout}"
                                           Minimum="1"
                                           Maximum="300"
                                           Increment="1"
                                           FormatString="0" />
                            <TextBlock Grid.Column="2"
                                       Text="seconds"
                                       VerticalAlignment="Center" />

                            <!-- TCP Mux -->
                            <TextBlock Grid.Column="3"
                                       Text="TCP Mux"
                                       VerticalAlignment="Center" />
                            <CheckBox Grid.Column="4"
                                      IsChecked="{Binding TcpMux}"
                                      VerticalAlignment="Center" />
                        </Grid>

                        <!-- Heartbeat -->
                        <Grid ColumnDefinitions="140,120,20,120" RowDefinitions="Auto,Auto">
                            <!-- Heartbeat Interval -->
                            <TextBlock Grid.Row="0" Grid.Column="0"
                                       Text="Heartbeat Interval"
                                       Classes="field-label" />
                            <NumericUpDown Grid.Column="1"
                                           Value="{Binding HeartbeatInterval}"
                                           Minimum="5"
                                           Maximum="300"
                                           Increment="5"
                                           FormatString="0" />
                            <TextBlock Grid.Column="2"
                                       Text="seconds"
                                       VerticalAlignment="Center" />

                            <!-- Heartbeat Timeout -->
                            <TextBlock Grid.Column="3"
                                       Text="Heartbeat Timeout"
                                       Classes="field-label" />
                            <NumericUpDown Grid.Column="4"
                                           Value="{Binding HeartbeatTimeout}"
                                           Minimum="5"
                                           Maximum="600"
                                           Increment="5"
                                           FormatString="0" />
                        </Grid>

                        <!-- TLS -->
                        <CheckBox IsChecked="{Binding TlsEnabled}">
                            <StackPanel Spacing="2">
                                <TextBlock Text="Enable TLS"
                                           FontWeight="Medium" />
                                <TextBlock Text="Encrypt communication with the frps server"
                                           Classes="hint" />
                            </StackPanel>
                        </CheckBox>
                    </StackPanel>
                </Border>

                <!-- Logging Section -->
                <Border Classes="card">
                    <StackPanel Spacing="{StaticResource SpacingM}">
                        <TextBlock Text="Logging"
                                   Classes="sectionTitle" />

                        <!-- Log Level and Max Days -->
                        <Grid ColumnDefinitions="140,180,20,Auto,120" RowDefinitions="Auto">
                            <!-- Log Level -->
                            <TextBlock Grid.Row="0" Grid.Column="0"
                                       Text="Log Level"
                                       Classes="field-label" />
                            <ComboBox Grid.Column="1"
                                      SelectedIndex="{Binding LogLevelIndex}">
                                <ComboBoxItem>Trace</ComboBoxItem>
                                <ComboBoxItem>Debug</ComboBoxItem>
                                <ComboBoxItem>Info</ComboBoxItem>
                                <ComboBoxItem>Warn</ComboBoxItem>
                                <ComboBoxItem>Error</ComboBoxItem>
                            </ComboBox>

                            <!-- Max Days -->
                            <TextBlock Grid.Column="3"
                                       Text="Max Days"
                                       Classes="field-label" />
                            <NumericUpDown Grid.Column="4"
                                           Value="{Binding LogMaxDays}"
                                           Minimum="1"
                                           Maximum="365"
                                           Increment="1"
                                           FormatString="0" />
                        </Grid>

                        <!-- Log To -->
                        <Grid ColumnDefinitions="140,*" RowDefinitions="Auto">
                            <TextBlock Grid.Row="0" Grid.Column="0"
                                       Text="Log To"
                                       Classes="field-label" />
                            <TextBox Grid.Column="1"
                                     Text="{Binding LogTo}"
                                     Watermark="e.g., console, /path/to/logfile" />
                        </Grid>
                    </StackPanel>
                </Border>

                <!-- Status Section -->
                <Border Classes="card"
                        IsVisible="{Binding IsValid}">
                    <StackPanel Spacing="{StaticResource SpacingS}">
                        <TextBlock Text="Status"
                                   Classes="sectionTitle" />

                        <TextBlock Text="{Binding ValidationError}"
                                   Foreground="{DynamicResource SystemControlErrorTextForegroundBrush}"
                                   IsVisible="{Binding HasValidationError}" />

                        <TextBlock Text="{Binding ValidationWarning}"
                                   Foreground="Orange"
                                   IsVisible="{Binding HasValidationWarning}" />

                        <TextBlock Text="Configuration is valid"
                                   Foreground="{DynamicResource SystemAccentColor1Brush}"
                                   IsVisible="{Binding IsValid}" />
                    </StackPanel>
                </Border>

                <!-- Action Buttons -->
                <StackPanel Orientation="Horizontal"
                            HorizontalAlignment="Right"
                            Spacing="{StaticResource SpacingM}"
                            Margin="{StaticResource ThicknessTopS}">
                    <Button Content="Reset to Defaults"
                            Command="{Binding ResetCommand}"
                            IsEnabled="{Binding !IsSaving}"
                            Classes="action-button" />

                    <Button Command="{Binding SaveCommand}"
                            IsEnabled="{Binding !IsSaving}"
                            Classes="action-button primary">
                        <StackPanel Orientation="Horizontal" Spacing="{StaticResource SpacingS}">
                            <TextBlock Text="Save Configuration" />
                            <ProgressBar IsIndeterminate="True"
                                          Width="16"
                                          Height="16"
                                          IsVisible="{Binding IsSaving}" />
                        </StackPanel>
                    </Button>
                </StackPanel>

            </StackPanel>
        </Panel>
    </ScrollViewer>
</UserControl>
